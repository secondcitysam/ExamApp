<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
  <title>{{ exam_name }} - Exam</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/quiz.css') }}">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <style>
    body {
      background-color: #f7fafa;
      font-family: 'Segoe UI', sans-serif;
    }
    .btn-nav {
      background-color: #5f9ea0;
      color: #fff;
      font-weight: 500;
    }
    .btn-nav:hover {
      background-color: #468b8b;
      color: #fff;
    }
    .card {
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    #confirmationBox {
      display: none;
      margin-top: 30px;
      padding: 30px;
      background: #e7f5f3;
      border: 1px solid #b7dfdb;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
  </style>
</head>

<body>
<header>
  <nav class="navbar navbar-expand-md">
    <span class="text" style="color: #5f9ea0; font-weight:600;">The Online Exam Proctor</span>
    <span class="ml-auto" id="timer" style="color: #333; font-weight:500;"></span>
  </nav>
</header>

<main>
  <div class="container mt-5">
    <div class="card">
      <div class="card-body">
        <h2 class="card-title mb-4 text-center" style="color: #5f9ea0;">{{ exam_name }}</h2>
        <hr class="line">

        <!-- Start Section -->
        <div id="mainContent" class="text-center">
          <h5>Answer the following questions within the time limit.</h5>
          <p>Incorrect answers may affect your score. Click below to begin.</p>
          <button type="submit" id="startQuiz" class="btn text-white rounded-pill mb-2 mt-2"
                  style="background: #5f9ea0;">Start Quiz</button>
        </div>

        <!-- Quiz Section -->
        <div id="quizContent" style="display:none;">
          <div id="questionContainer" class="mt-3"></div>

          <div class="d-flex justify-content-between mt-4">
            <button id="prevBtn" class="btn btn-nav" disabled>Previous</button>
            <button id="nextBtn" class="btn btn-nav">Next</button>
            <button id="submitBtn" class="btn btn-success" style="display:none;">Submit</button>
          </div>
        </div>

        <!-- Confirmation Box -->
        <div id="confirmationBox"></div>
      </div>
    </div>
  </div>

  <footer class="text-center mt-5">
    <p>&copy; The Online Exam Proctor System</p>
  </footer>
</main>

<!-- ✅ Exam ID and Student Name Passed from Flask -->
<script>
  window.examId = {{ exam_id | tojson }};
  const studentName = {{ student_name | tojson }};
  console.log("Loaded examId:", window.examId, "Student:", studentName);
</script>

<script>
  let questions = [];
  let currentQuestion = 0;
  let selectedAnswers = {};
  const quizContainer = document.getElementById('questionContainer');
  const nextBtn = document.getElementById('nextBtn');
  const prevBtn = document.getElementById('prevBtn');
  const submitBtn = document.getElementById('submitBtn');

  // Load Questions
  function loadQuestions() {
    fetch(`/getExamQuestions?exam_id=${window.examId}`)
      .then(res => res.json())
      .then(data => {
        questions = data;
        if (questions.length === 0) {
          quizContainer.innerHTML = "<p class='text-center text-danger'>⚠️ No questions found!</p>";
          return;
        }
        showQuestion(0);
      })
      .catch(err => {
        console.error("Error loading questions:", err);
        quizContainer.innerHTML = "<p class='text-center text-danger'>⚠️ Failed to load questions!</p>";
      });
  }

  // Show Question
  function showQuestion(index) {
    const q = questions[index];
    quizContainer.innerHTML = `
      <h5 class="text-center mb-3">${index + 1}. ${q.title}</h5>
      <div class="list-group">
        ${q.choices.map(choice => `
          <button type="button" class="list-group-item list-group-item-action ${selectedAnswers[index] === choice ? 'active' : ''}"
            onclick="selectAnswer(${index}, '${choice}')">${choice}</button>
        `).join('')}
      </div>
    `;
    prevBtn.disabled = (index === 0);
    nextBtn.style.display = (index === questions.length - 1) ? 'none' : 'inline-block';
    submitBtn.style.display = (index === questions.length - 1) ? 'inline-block' : 'none';
  }

  function selectAnswer(index, choice) {
    selectedAnswers[index] = choice;
    showQuestion(index);
  }

  // Navigation
  nextBtn.addEventListener('click', () => {
    if (currentQuestion < questions.length - 1) {
      currentQuestion++;
      showQuestion(currentQuestion);
    }
  });
  prevBtn.addEventListener('click', () => {
    if (currentQuestion > 0) {
      currentQuestion--;
      showQuestion(currentQuestion);
    }
  });

  // Start Quiz
  document.getElementById('startQuiz').addEventListener('click', () => {
    document.getElementById('mainContent').style.display = 'none';
    document.getElementById('quizContent').style.display = 'block';
    loadQuestions();
  });

  // Submit Answers
  submitBtn.addEventListener('click', () => {
    fetch("/submitExam", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({
        exam_id: window.examId,
        answers: selectedAnswers
      })
    })
    .then(res => res.json())
    .then(data => {
      console.log("Server result:", data);
      document.getElementById('quizContent').style.display = 'none';
      const box = document.getElementById('confirmationBox');
      box.style.display = 'block';
      box.innerHTML = `
        <h4>✅ Exam Submitted Successfully!</h4>
        <p><b>Total Marks:</b> ${data.marks}/${data.total}</p>
        <p><b>Percentage:</b> ${data.percentage}%</p>
        <p><b>Status:</b> ${data.status}</p>
        <a href="/showResult/${studentName};${data.status};${data.marks}/${data.total};${data.percentage};Profile.jpg"
           class="btn btn-nav mt-2">View Detailed Result</a>
      `;
    })
    .catch(err => {
      console.error("Error submitting exam:", err);
      alert("Failed to submit exam. Please try again.");
    });
  });
</script>

<!-- Bootstrap JS -->
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js"></script>
</body>
</html>
